<template>
  <div class="min-h-screen bg-gray-50 p-6">
    <Nav />

    <div class="max-w-6xl mx-auto bg-white rounded-lg shadow p-6 mt-16 md:mt-20">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 space-y-4 sm:space-y-0">
        <h1 class="text-2xl font-semibold">All cToons</h1>
        <div class="flex space-x-2">
          <NuxtLink
            to="/admin/addCtoon"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            Create cToon
          </NuxtLink>

          <NuxtLink
            to="/admin/bulk-upload-ctoons"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            Bulk Upload cToons
          </NuxtLink>
        </div>
      </div>

      <!-- FILTER BAR -->
      <div class="flex flex-col sm:flex-row gap-4 mb-6">
        <input
          type="text"
          v-model="searchTerm"
          placeholder="Search by name…"
          class="flex-1 border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500"
        />
        <select
          v-model="selectedSet"
          class="border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500"
        >
          <option value="">All Sets</option>
          <option v-for="set in setsOptions" :key="set" :value="set">
            {{ set }}
          </option>
        </select>
        <select
          v-model="selectedSeries"
          class="border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500"
        >
          <option value="">All Series</option>
          <option v-for="series in seriesOptions" :key="series" :value="series">
            {{ series }}
          </option>
        </select>
      </div>

      <!-- TABLE VIEW (desktop) -->
      <div class="overflow-x-auto hidden sm:block">
        <table class="min-w-full table-auto border-collapse">
          <thead>
            <tr class="bg-gray-100">
              <th class="px-4 py-2 text-left">Asset</th>
              <th class="px-4 py-2 text-left">Name</th>
              <th class="px-4 py-2 text-left">Release Date (CDT)</th>
              <th class="px-4 py-2 text-left">Rarity</th>
              <th class="px-4 py-2 text-right">Highest Mint</th>
              <th class="px-4 py-2 text-right">Quantity</th>
              <th class="px-4 py-2 text-center">In C-mart</th>
              <th class="px-4 py-2 text-right">Edit</th>
            </tr>
          </thead>
          <tbody>
            <tr
              v-for="c in displayedCtoons"
              :key="c.id"
              class="border-b hover:bg-gray-50"
            >
              <td class="px-4 py-2">
                <img
                  loading="lazy"
                  :src="c.assetPath"
                  :alt="c.name"
                  class="h-16 w-auto mx-auto rounded"
                />
              </td>
              <td class="px-4 py-2">{{ c.name }}</td>
              <td class="px-4 py-2 whitespace-nowrap">
                {{
                  new Date(c.releaseDate).toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'America/Chicago',
                    timeZoneName: 'short'
                  })
                }}
              </td>
              <td class="px-4 py-2">{{ c.rarity }}</td>
              <td class="px-4 py-2 text-right">{{ c.highestMint }}</td>
              <td class="px-4 py-2 text-right">
                {{ c.quantity == null ? 'Unlimited' : c.quantity }}
              </td>
              <td class="px-4 py-2 text-center">
                {{ c.inCmart ? 'Yes' : 'No' }}
              </td>
              <td class="px-4 py-2 text-right">
                <NuxtLink
                  :to="`/admin/editCtoon/${c.id}`"
                  class="text-blue-600 hover:text-blue-800"
                >Edit</NuxtLink>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- CARD VIEW (mobile) -->
      <div class="space-y-4 block sm:hidden">
        <div
          v-for="c in displayedCtoons"
          :key="c.id"
          class="bg-gray-100 rounded-lg p-4 flex flex-col"
        >
          <div class="flex items-start space-x-4">
            <img
              loading="lazy"
              :src="c.assetPath"
              :alt="c.name"
              class="max-w-[80px] w-auto flex-shrink-0 object-contain rounded"
            />
            <div class="flex-1 space-y-1">
              <h2 class="text-lg font-semibold">{{ c.name }}</h2>
              <p class="text-sm text-gray-600">
                {{
                  new Date(c.releaseDate).toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'America/Chicago'
                  })
                }}
              </p>
              <p class="text-sm"><strong>Rarity:</strong> {{ c.rarity }}</p>
              <p class="text-sm"><strong>Highest Mint:</strong> {{ c.highestMint }}</p>
              <p class="text-sm"><strong>Quantity:</strong> {{ c.quantity == null ? 'Unlimited' : c.quantity }}</p>
              <p class="text-sm"><strong>In C-mart:</strong> {{ c.inCmart ? 'Yes' : 'No' }}</p>
              <p class="text-sm"><strong>Set:</strong> {{ c.set }}</p>
              <p class="text-sm"><strong>Series:</strong> {{ c.series }}</p>
            </div>
          </div>
          <NuxtLink
            :to="`/admin/editCtoon/${c.id}`"
            class="mt-4 inline-block bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-center text-sm font-medium self-end"
          >
            Edit
          </NuxtLink>
        </div>
      </div>

      <!-- SEARCH STATES -->
      <div v-if="isSearching && searching" class="text-center py-4">Searching…</div>
      <div v-if="isSearching && !searching && displayedCtoons.length===0" class="text-center py-4 text-gray-500">
        No matches.
      </div>

      <!-- PAGINATION (browse only) -->
      <div v-if="!isSearching" class="mt-6 flex items-center justify-between">
        <button
          class="px-4 py-2 border rounded disabled:opacity-50"
          @click="prevPage"
          :disabled="currentPage===1 || loading"
        >
          Previous
        </button>
        <div class="text-sm text-gray-600">
          Page {{ currentPage }}
          <span v-if="loading" class="ml-2">Loading…</span>
        </div>
        <button
          class="px-4 py-2 border rounded disabled:opacity-50"
          @click="nextPage"
          :disabled="!hasNextPage || loading"
        >
          Next
        </button>
      </div>
    </div>
  </div>
</template>

<script setup>
definePageMeta({ middleware: ['auth','admin'], layout: 'default' })

import { ref, onMounted, computed, watch } from 'vue'
import Nav from '~/components/Nav.vue'

/* Meta options from API */
const setsOptions   = ref([])
const seriesOptions = ref([])

async function loadMeta() {
  const res = await fetch('/api/collections/meta', { credentials: 'include' })
  if (!res.ok) return
  const meta = await res.json()
  setsOptions.value = (meta.sets || []).filter(s => s && String(s).trim().length > 0)
  seriesOptions.value = (meta.series || []).filter(s => s && String(s).trim().length > 0)
}

/* Paging */
const pageSize     = 50
const currentPage  = ref(1)
const hasNextPage  = ref(false)
const loading      = ref(false)
const rawCtoons    = ref([])

/* Search + filters */
const searchTerm     = ref('')
const selectedSet    = ref('')
const selectedSeries = ref('')
const isSearching    = ref(false)
const searching      = ref(false)
const searchResults  = ref([])
let   searchTimer    = null
let   lastSearchKey  = 0

/* Source list */
const sourceCtoons = computed(() => isSearching.value ? searchResults.value : rawCtoons.value)

/* Displayed list */
const displayedCtoons = computed(() => {
  if (isSearching.value) return sourceCtoons.value
  const q = (searchTerm.value || '').toLowerCase()
  return sourceCtoons.value.filter(c => !q || c.name.toLowerCase().includes(q))
})

/* Browse paging */
async function loadPage(n = 1) {
  loading.value = true
  const skip = (n - 1) * pageSize
  const take = pageSize + 1
  const res = await fetch(`/api/admin/all-ctoons?skip=${skip}&take=${take}`, { credentials: 'include' })
  if (!res.ok) { loading.value = false; return }
  const page = await res.json()
  hasNextPage.value = page.length > pageSize
  rawCtoons.value = hasNextPage.value ? page.slice(0, pageSize) : page
  currentPage.value = n
  loading.value = false
}
function nextPage() { if (hasNextPage.value && !loading.value) loadPage(currentPage.value + 1) }
function prevPage() { if (currentPage.value > 1 && !loading.value) loadPage(currentPage.value - 1) }

/* Search */
async function runSearch({ q, set, series }) {
  const key = ++lastSearchKey
  searching.value = true
  try {
    const params = new URLSearchParams()
    if (q) params.set('q', q)
    if (set) params.set('set', set)
    if (series) params.set('series', series)
    const res = await fetch(`/api/admin/search-ctoons?${params.toString()}`, { credentials: 'include' })
    if (!res.ok) throw new Error('Search failed')
    const data = await res.json()
    if (key === lastSearchKey) searchResults.value = data
  } catch {
    if (key === lastSearchKey) searchResults.value = []
  } finally {
    if (key === lastSearchKey) searching.value = false
  }
}
function enterSearchMode() { isSearching.value = true }
function exitSearchMode() { isSearching.value = false; searchResults.value = []; searching.value = false }

/* React to name + filters */
watch([searchTerm, selectedSet, selectedSeries], ([nameQ, setVal, seriesVal]) => {
  clearTimeout(searchTimer)
  const q = String(nameQ || '').trim()
  const filtersActive = !!(setVal || seriesVal)

  if (q.length >= 3 || filtersActive) {
    enterSearchMode()
    if (q.length >= 3) {
      searchTimer = setTimeout(() => runSearch({ q, set: setVal, series: seriesVal }), 300)
    } else {
      runSearch({ q: '', set: setVal, series: seriesVal })
    }
  } else {
    exitSearchMode()
  }
})

onMounted(() => {
  loadMeta()
  loadPage(1)
})
</script>

<style scoped>
th, td { vertical-align: middle; }
</style>
